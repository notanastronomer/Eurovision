---
title: "Spotify Eurovision"
author: "Lauren Gilbert"
output: pdf_document
---

``` {r}
library(unpivotr)
library(devtools)
library(spotifyr)
library(tidyverse)
library(mice)
library(stringi)
```

```{r}
library(rvest)

remove_footnotes <- function(dat)
{
  as.numeric(gsub("[a-z]", "", dat))
}

get_table <- function(year, xpath)
{
  str <- paste("https://en.wikipedia.org/wiki/Eurovision_Song_Contest_", toString(year), sep = "")
  yeartable<-read_html(str) %>% html_node(xpath=xpath) %>% html_table()
  colnames(yeartable) <- c("Draw", "To", "Artist", "Song", "Language", "Place", "Points")
  yeartable$Year <- as.numeric(year)
  return(yeartable)
}

semifinal <- function(year, xpath1, xpath2)
{
  yeartable1 <- get_table(year, xpath1)
  yeartable1$Type <- "sf1"
  yeartable2 <- get_table(year, xpath2)
  yeartable2$Type <- "sf2"
  semi <- rbind(yeartable1, yeartable2)
  return(semi)
}

final <- function(year, xpath)
{
  yeartable <- get_table(year, xpath)
  yeartable$Type <- "f"
  yeartable$Place <- remove_footnotes(yeartable$Place)
  yeartable$Draw <- as.numeric(gsub("\\[.+\\]", "", yeartable$Draw))
  return(yeartable)
}

years <- c(2009:2011, 2013:2019)

dat <- lapply(years, semifinal, xpath1 = '//*[@id="mw-content-text"]/div[1]/table[4]', xpath2 = '//*[@id="mw-content-text"]/div[1]/table[5]') %>% bind_rows()
dat <- rbind(dat, lapply(years, final, xpath = '//*[@id="mw-content-text"]/div[1]/table[6]') %>% bind_rows())

years <- c(2008, 2012)
dat <- rbind(dat, lapply(years, semifinal, xpath1 = '//*[@id="mw-content-text"]/div[1]/table[3]', xpath2 = '//*[@id="mw-content-text"]/div[1]/table[4]') %>% bind_rows())

dat <- rbind(dat, lapply(years, final, xpath = '//*[@id="mw-content-text"]/div[1]/table[5]') %>% bind_rows())
```

``` {r}
rename_country <- function(dat, old_name, new_name)
{
  dat$To[dat$To == old_name] <- new_name
  dat$From[dat$From == old_name] <- new_name
  return(dat)
}

scores <- readxl::read_xlsx("eurovision_song_contest_1975_2019.xlsx")
scores <- scores %>% filter(Type == 'f') %>% filter(Points > 0) %>% filter(Year > 2007) %>% select(Year, Points, From, To, Jury)

scores <- rename_country(scores, "Bosnia & Herzegovina", "Bosnia and Herzegovina")
scores <- rename_country(scores, "F.Y.R. Macedonia", "North Macedonia")
scores <- rename_country(scores, "The Netherlands", "Netherlands")

songtitles <- dat
songtitles$To[songtitles$To == "Macedonia"] <- "North Macedonia"
scores <- left_join(scores, songtitles, by = c("To", "Year"))

scores$Artist <- tolower(stri_trans_general(str = scores$Artist, id = "Latin-ASCII"))
scores$Artist <- gsub(" and ", " & ", scores$Artist)
scores$Artist <- gsub("\\[.+\\]", "", scores$Artist)
scores$Language <- gsub("\\[.+\\]", "", scores$Language)
scores$Draw <- gsub("\\[.+\\]", "", scores$Draw)
scores$Place <- gsub("\\[.+\\]", "", scores$Place)
scores$Place <- as.numeric(as.character(scores$Place))
scores$Draw <- as.numeric(as.character(scores$Draw))

scores$Artist[scores$Artist == "o'g3ne"] <- "og3ne"
```

``` {r}
Sys.setenv(SPOTIFY_CLIENT_ID = 'cd564f2f03e147f5a7c7a6eb40997280')
Sys.setenv(SPOTIFY_CLIENT_SECRET = '6a6c85ff2d0d407093eae58096d691ce')
access_token <- get_spotify_access_token()

get_spotify_year <- function(playlist)
{
  eurovision <- get_playlist_audio_features("spotify", playlist, authorization = get_spotify_access_token())
  for (i in 1:length(eurovision$track.artists))
  {
    if (length(eurovision$track.artists[[i]]$name) > 1)
    {
      eurovision$track.artists[[i]]$name[1] <- paste(eurovision$track.artists[[i]]$name[1],  "&", eurovision$track.artists[[i]]$name[2])
    }
  }

  eurovision$Artist <- do.call(rbind, (lapply(eurovision$track.artists, function(x) x[1,])))$name
  spotify_data <- eurovision %>% select(Artist, track.album.name, danceability, energy, key, loudness, mode, speechiness, acousticness, instrumentalness, liveness, valence, tempo, track.duration_ms, track.name, key_name, mode_name)
  spotify_data$Artist <- tolower(stri_trans_general(str = spotify_data$Artist, id = "Latin-ASCII"))
  spotify_data$Artist <- gsub(" and ", " & ", spotify_data$Artist)
  return(spotify_data)
}

playlists_complete <- c("3ZdQUt8Tmtt7oOU8UM2koe", "5sxwk5T34E2l2Ng02lipHS", "6Ey20ccpxRCd0AlaIuGJrB", "0VEtwmjx3FK77jWLlI16EV", "1HtXxHLxLvC5ePfd0hQC7U", "2ldMrwGLibJCxPrqvCx1p5", "2YPpTFZPn6s1y7q8PFRLv7", "1GEIW1EK1myFWQVgzkQo6Z")
playlists_partial <- c("4HPdL5jwsxKnh7RTAwq9hF", "5VqYaQDMWRzR5bOCKBvLF8", "0yoZw30ogd6gENBtx0q0HS", "1X6om0uyKtmxblTN6JK5dj")

complete_years_12_19 <- as.data.frame(do.call(rbind, lapply(playlists_complete, get_spotify_year)))
partial_years_09_12 <- as.data.frame(do.call(rbind, lapply(playlists_partial, get_spotify_year)))
```

``` {r}
complete_years_12_19$Artist[complete_years_12_19$Artist == "miki nunez"] <- "miki"
complete_years_12_19$Artist[complete_years_12_19$Artist == "zalagasper"] <- "zala kralj & gasper santl"
complete_years_12_19$Artist[complete_years_12_19$Artist == "claudia pascoal & isaura"] <- "claudia pascoal"
complete_years_12_19$Artist[complete_years_12_19$Artist == "amaia & alfred garcia"] <- "amaia & alfred"
complete_years_12_19$Artist[complete_years_12_19$Artist == "isaiah firebrace"] <- "isaiah"
complete_years_12_19$Artist[complete_years_12_19$Artist == "ilinca & alex florea"] <- "ilinca ft. alex florea"
complete_years_12_19$Artist[complete_years_12_19$Artist == "og3ne"] <- "og3ne"
complete_years_12_19$Artist[complete_years_12_19$Artist == "anja nissen"] <- "anja"
complete_years_12_19$Artist[complete_years_12_19$Artist == "papai joci"] <- "joci papai"
complete_years_12_19$Artist[complete_years_12_19$Artist == "minus-one"] <- "minus one"
complete_years_12_19$Artist[complete_years_12_19$Artist == "zaa sanja vucic"] <- "sanja vucic zaa"
complete_years_12_19$Artist[complete_years_12_19$Artist == "justs sirmais"] <- "justs"
complete_years_12_19$Artist[complete_years_12_19$Artist == "monika linkyte"] <- "monika linkyte & vaidas baumila"
complete_years_12_19$Artist[complete_years_12_19$Artist == "kallay saunders"] <- "andras kallay-saunders"
complete_years_12_19$Artist[complete_years_12_19$Artist == "freaky fortune & riskykidd"] <- "freaky fortune feat. riskykidd"
complete_years_12_19$Artist[complete_years_12_19$Artist == "ovi & paula seling"] <- "paula seling & ovi"
complete_years_12_19$Artist[complete_years_12_19$Artist == "gianluca bezzina"] <- "gianluca"
complete_years_12_19$Artist[complete_years_12_19$Artist == "koza mostra & agathonas iakovidis"] <- "koza mostra feat. agathon iakovidis"
complete_years_12_19$Artist[complete_years_12_19$Artist == "birgit oigemeel"] <- "birgit"
complete_years_12_19$Artist[complete_years_12_19$Artist == "el sueno de morfeo"] <- "esdm"
complete_years_12_19$Artist[complete_years_12_19$Artist == "pasha parfeni"] <- "pasha parfeny"
complete_years_12_19$Artist[complete_years_12_19$Artist == "buranovskie babushki"] <- "buranovskiye babushki"
```

``` {r}
partial_years_09_12$Artist[partial_years_09_12$Artist == "paula seling & ovi"] <- "paula seling &  ovi"
partial_years_09_12$Artist[partial_years_09_12$Artist == "giorgos alkaios"] <- "giorgos alkaios & friends"
partial_years_09_12$Artist[partial_years_09_12$Artist == "peter nalitch"] <- "peter nalitch & friends" 
partial_years_09_12$Artist[partial_years_09_12$Artist == "ell/nikki"] <- "ell & nikki"
partial_years_09_12$Artist[partial_years_09_12$Artist == "loukas yorkas & stereo mike"] <- "loukas giorkas feat. stereo mike"
partial_years_09_12$Artist[partial_years_09_12$Artist == "sjonniÂ´s friends"] <- "sjonni's friends"
partial_years_09_12$Artist[partial_years_09_12$Artist == "malena ernman & fredrik kempe"] <- "malena ernman"
partial_years_09_12$Artist[partial_years_09_12$Artist == "soraya"] <- "soraya arnelas"
partial_years_09_12$Artist[partial_years_09_12$Artist == "anastasia prikhodko"] <- "anastasiya prikhodko" 
partial_years_09_12$Artist[partial_years_09_12$Artist == "igor cukrov & andrea susnjara"] <- "igor cukrov feat. andrea"
partial_years_09_12$Artist[partial_years_09_12$Artist == "brinck"] <- "niels brinck" 
partial_years_09_12$Artist[partial_years_09_12$Artist == "loboda"] <- "svetlana loboda" 
partial_years_09_12$Artist[partial_years_09_12$Artist == "alex sparrow"] <- "alexey vorobyov" 
partial_years_09_12$Artist[partial_years_09_12$Artist == "brajic"] <- "vukasin brajic"
partial_years_09_12$Artist[partial_years_09_12$Artist == "boaz"] <- "boaz ma'uda"
partial_years_09_12$Artist[partial_years_09_12$Artist == "jelena tomasevic & bora dugic"] <- "jelena tomasevic feat. bora dugic"
partial_years_09_12$Artist[partial_years_09_12$Artist == "rodolfo chikilcuatre & tata golosa"] <- "rodolfo chikilicuatre"
partial_years_09_12$Artist[partial_years_09_12$Artist == "vania"] <- "vania fernandes"
partial_years_09_12$Artist[partial_years_09_12$Artist == "kraljevi ulice"] <- "kraljevi ulice & 75 cents"
partial_years_09_12$Artist[partial_years_09_12$Artist == "nico und vlad mirita"] <- "nico & vlad" 
```

Missing:
2011: 2
2010: 1

``` {r}
year_set <- rbind(complete_years_12_19, partial_years_09_12)

temp <- subset(year_set, duplicated(year_set$Artist))

scores_with_musical <- left_join(scores, year_set, by = "Artist")
fixthis <- subset(scores_with_musical, !complete.cases(scores_with_musical))
unique(fixthis$Artist)
```

``` {r}
sums <- scores_with_musical %>% filter(Year > 2015) %>%
  group_by(Year, To) %>% 
  mutate(total = sum(Points.x)) %>% ungroup()

sums <- sums %>% filter(Year > 2015) %>%
  group_by(Year) %>% 
  mutate(year_total = sum(Points.x))
```



2021: 0xGk0xR6fI88NsmiHZZMPE
2020: 0IyJJbmF3vp5nX6j4FFeDO

2019: 3ZdQUt8Tmtt7oOU8UM2koe
2018: 5sxwk5T34E2l2Ng02lipHS
2017: 6Ey20ccpxRCd0AlaIuGJrB
2016: 0VEtwmjx3FK77jWLlI16EV
2015: 1HtXxHLxLvC5ePfd0hQC7U
2014: 2ldMrwGLibJCxPrqvCx1p5
2013: 2YPpTFZPn6s1y7q8PFRLv7
2012: 1GEIW1EK1myFWQVgzkQo6Z

2011: 4HPdL5jwsxKnh7RTAwq9hF
2010: 5VqYaQDMWRzR5bOCKBvLF8
2009: 0yoZw30ogd6gENBtx0q0HS
2008: 1X6om0uyKtmxblTN6JK5dj